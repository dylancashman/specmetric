<html>
  <head>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hyperformula/dist/hyperformula.full.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />

  </head>

  <body>
    <div id="example"></div>

    <script>

const hf = HyperFormula.buildEmpty({
  // to use an external HyperFormula instance,
  // initialize it with the `'internal-use-in-handsontable'` license key
  licenseKey: 'internal-use-in-handsontable',
});

const container = document.querySelector('#example');

// logDFG({sheet: 0, row: 3, col: 3})
const logDFG = (address) => {
  const datadict = {};
  // root = ComputationNode('root', None, 'scalar_sqrt', input_data=['mean_square_error'], output_data='root_mean_square_error');
  // mean = ComputationNode('mean', root, 'mean', input_data=['square_y_i_minus_y_hat_i'], output_data='mean_square_error');
  // square_residuals = ComputationNode('square_y_i_minus_y_hat_i', mean, 'vector_square', input_data=['y_i_minus_y_hat_i'], output_data='square_y_i_minus_y_hat_i');
  // vector_difference_residuals = ComputationNode('vector_difference_residuals', square_residuals, 'vector_diff', input_data=['y_i', 'y_hat_i'], output_data='y_i_minus_y_hat_i');
  // y_i_res_node = ComputationNode('literal_yi_res', vector_difference_residuals, 'vector', output_data='y_i');
  // y_hat_node = ComputationNode('literal_yhat', vector_difference_residuals, 'vector', output_data='y_hat_i');

  const nodes = [];
  const toVisit = [{addr: address, parent: null}];
  while (toVisit.length > 0) {
    // Load the node to send to the server
    const visited = toVisit.shift();
    const visitVal = hf.getValue(visited.addr);
    datadict[str(visited.addr)] = visitVal;
    const curr = {
      name: str(visited.addr),
      parent: visited.parent,
      input_data: [],
      output_data: str(visited.addr)
    };

    const hasFormula = hf.doesCellHaveFormula(visited.addr);
    if (hasFormula) {
      const formula = hf.getFormula(visited.attr);
      if (formula.includes("SUM")) {
        curr['function'] = 'vector_sum';
        // Child is a vector
        // =SUM(C2:C5)

        curr['input_data'] = [formula.slice(5)];
      }
      if (formula.includes("AVERAGE")) {
        curr['function'] = 'mean';
        // Child is a vector
        // =AVERAGE(C2:C5)

        curr['input_data'] = [formula.slice(9)];
      }
      if (formula.includes("+")) {
        curr['function'] = 'scalar_sum';
        // =B2-C2
        curr['input_data'] = [formula.slice(1,2), formula.slice(4,2)];
      }
      if (formula.includes("-")) {
        curr['function'] = 'scalar_diff';
        curr['input_data'] = [formula.slice(1,2), formula.slice(4,2)];
      }
    } else {
      curr['function'] = 'scalar';
    }

    nodes.push(curr);


    // BFS
    const precedents = hf.getCellPrecedents(address)
    if (['vector_sum', 'mean'].includes(curr['function'])) {
      // children are vectors
      // In this example, we limit ourselves to depth 1 under vector
      // Get the data, assign it to formula - function name
      const precVals = precedents.map((p) => {
        return hf.getValue(p);
      });
      data_dict[curr['input_data']] = precVals;

      const childNode = {
        name: str(formula),
        parent: curr.name,
        function: 'vector',
        input_data: [str(formula)],
        output_data: visitVal
      };

      nodes.push(childNode);
    } else {
      for (const p in precedents) {
        toVisit.push({addr: p, parent: curr.name});
      }      
    }
    console.log("In here, nodes is ", nodes)
  }
};

const afterFormulasValuesUpdate = (changes) => {
  console.log("values update")
  changes.forEach((change) => {
    console.log('change', change.address, change.newValue);

    console.log('precedents', hf.getCellPrecedents({ sheet: change.address.sheet, col: change.address.col, row: change.address.row}));
  });
};

const hot = new Handsontable(container, {
  data: [
    ['Month', 'Revenue', 'Expense', 'P/L'],
    ['Jan', 1.1, 1, 0.1],
    ['Feb', 1.8, 0.9, 0],
    ['Mar', 0.7, 0.5, 0],
    [0, 0, 0, 0]
  ],
  rowHeaders: true,
  colHeaders: true,
  formulas: {
    engine: hf,
    sheetName: 'Sheet1',
  },
  afterFormulasValuesUpdate,
  licenseKey: 'non-commercial-and-evaluation' // for non-commercial use only
});
    </script>
  </body>